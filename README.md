# 定时问候插件 (Timed Greeting Plugin)

**插件版本: 0.2.0**

- 这是一个为 MaiBot 设计的功能插件，它允许您设置多个定时任务，在指定的时间范围内，向配置好的QQ用户或群组发送由大语言模型（LLM）生成的、包含特定关键词和人设的问候语。

- 麦麦bot官方项目：https://github.com/MaiM-with-u



> [!NOTE]
>
> **免责声明**
> 本插件代码由谷歌的 **Gemini大型语言模型（LLM）** 进行编写。作者不对因使用本插件或其生成内容所导致的任何直接或间接的问题、损失或纠纷承担任何责任。**请用户自行评估风险并谨慎使用**。



## ⚠️ 注意事项

在使用本插件前，请务必阅读并理解以下几点，以确保插件能够顺利运行：

1. **`config.toml`配置文件缺失**：
   - 当手动或意外导致配置文件缺失，**不要使用插件自动生成的文件**。
   - 手动复制插件根目录下的`template_config.toml`文件里的**全部内容**到`config.toml`。

2. **适配器白名单**
   您**必须**在适配器(adapter)的配置文件中，将需要接收问候语的群组和用户的QQ号添加至适配器的白名单内。

3. **启用私聊功能**
   如果您希望向私聊用户发送问候，请确保 `MaiBot` 的主配置文件 `bot_config.toml` 中，启用了私聊功能。

4. **消息发送前提**

   *   **对于私聊**：麦麦需要**至少与目标用户有过一次对话**。最稳妥的方式是让用户和麦麦有一次成功的对话。
   *   **对于群聊**：麦麦需要在目标群聊中**有过一次成功的消息收发记录**（成功回复过群成员消息）。
   *   如果目标是全新的、从未与机器人互动过的私聊或群聊，插件在尝试发送时会在后台提示“发送失败”。

5. **任务名格式要求**
   所有在 `[schedules]` 中定义的任务名（例如 `morning_greeting`, `custom_task`）**只能使用大小写英文字母和下划线 (`_`)**。使用任何其他字符（如中文、短横线、空格等）都会导致插件加载失败，并向管理员发送错误通知。

   



## ✨ 功能特性

- **多任务调度**: 您可以同时设置多个独立的问候任务，例如“早安”、“晚安”或任何自定义提醒。
- **随机化发送**: 在设定的时间段内（如 08:00 到 09:00），插件会随机选择一个精确的时间点发送消息，让问候更显自然。
- **动态人设注入**: 自动从 `bot_config.toml` 获取您设置的 `personality.personality_core` 和 `personality.personality_side`，并将其组合成完整人设，确保问候语风格与您的Bot形象统一。
- **关键词模板**: 每个任务都可以配置一组关键词（如“早安”、“元气满满”）和一个提示词模板。插件会随机挑选一个关键词填入模板，生成丰富多样的问候内容。
- **灵活的目标配置**: 可以轻松地将问候语发送给一个或多个私聊用户及QQ群。
- **智能启动与重置**: 插件启动时会自动跳过当天已过时的任务，避免发送“迟到”的问候。
- **管理员测试命令**: 管理员可以通过简单的命令，随时测试任意一个任务的生成和发送效果。
- **支持跨天任务**: 您可以设置跨越零点的时间窗口（如 `start_time = "22:00", end_time = "01:00"`），插件会自动处理。



## 🚀 如何使用

0. 将 `timed_greeting_plugin` 文件夹放入 MaiBot 的 `plugins` 目录下。

1.  **启用插件**: 确保 `config.toml` 中的 `[plugin]` -> `enabled` 设置为 `true`。
2.  **配置管理员**: 在 `[plugin]` -> `admin_qqs` 列表中填入您的QQ号，以便您可以使用测试命令。
3.  **配置发送目标**: 在 `[[targets]]` 部分，根据您的需求，在 `type = "private"` 或 `type = "group"` 的 `id` 列表中填入目标的QQ号或群号。
4.  **配置定时任务**: 在 `[schedules]` 部分，您可以修改现有的 `morning_greeting` 和 `evening_greeting` 任务，或参考下面的“配置示例”添加新的任务。
5.  **重启 MaiBot**: 保存您的配置并重启Bot。



## ⚙️ 配置详解 (`config.toml`)

插件的配置文件分为三个主要部分：`plugin`（基础设置）、`targets`（发送目标）和 `schedules`（定时任务）。

### `[schedules]` 配置示例

您可以仿照下面的格式，在 `config.toml` 的 `[schedules]` 下添加新的任务块。任务块的名称（如此处的 `custom_task`）可以自定义但要唯一，且只能使用**大小写英文字母和下划线 (`_`)**。

```toml
# 示例任务，默认不启用
[schedules.custom_task]

# true为启用，false为关闭
enabled = false

# 任务窗口(24小时制)：
## 任务会在start_time和end_time设置的时间段随机指定一个时间发送问候消息。
## 意思是15:00-15:30之间随机选择一个时间，例如这次是15:05发送消息，下次是15:25发送消息。
## 支持跨天设置，如 start_time = "22:00", end_time = "01:00"。
start_time = "15:00"
end_time = "15:30"

# keywords: 关键词列表。
# 插件会从中随机选择一个，并用它来填充下面的 prompt_template。
keywords = ["学习", "加油", "努力"]

# prompt_template: 发送给LLM的指令模板(Prompt)。
# {keyword} 会被替换为上面 keywords 列表中的随机一个关键词。
# {persona} 会被替换为全局配置中的人设。
prompt_template = "我的设定是'{persona}'。现在是学习时间，请根据关键词 '{keyword}' 生成一句简短、有力的鼓励话语。"
```



## 🛠️ 管理员命令

您可以在私聊或群聊中通过以下命令来测试您的任务配置：

-   `/test_greeting <schedule_name>`
    -   **功能**: 手动触发指定任务的问候语生成，并将结果**仅发送给您自己**，用于测试提示词（Prompt）的效果。
    -   **示例**: `/test_greeting morning_greeting`
    -   **注意**: 只有在 `admin_qqs` 列表中的用户才能使用此命令。`<schedule_name>` 对应您在 `config.toml` 中设置的任务名（如 `morning_greeting`、`evening_greeting` 等）。
        -   非管理员使用命令时：群聊内无任何回复。私聊提示无权限。